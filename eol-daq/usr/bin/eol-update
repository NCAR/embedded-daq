#!/bin/sh

logfile=$(mktemp /tmp/${0##*/}_XXXXXX)
# trap "{ rm -f $logfile; }" EXIT

set -x

apt-get update \
    -o Dir::Etc::sourcelist="sources.list.d/eol.list" \
    -o Dir::Etc::sourceparts="-" -o APT::Get::List-Cleanup="0" > $logfile 2>&1

if [ $? -ne 0 ]; then

    cat $logfile
    if grep -q "^E: Problem with MergeList" $logfile; then
        bad=$(sed -r -n -e "/^E: Problem with MergeList/s/^E:.*MergeList *//p" $logfile)
        echo "Removing $bad"
        rm -f $bad
    fi

    # apt-get clean?

    apt-get update \
        -o Dir::Etc::sourcelist="sources.list.d/eol.list" \
        -o Dir::Etc::sourceparts="-" -o APT::Get::List-Cleanup="0" > $logfile 2>&1 || cat $logfile
fi

