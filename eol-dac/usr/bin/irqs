#!/bin/bash

if [ $# -eq 1 ]; then
	if [ $1 == "-h" ]; then
		echo "Prints interrupts per second. First argument can be time to wait between calculations."
		echo "If no time is specified, default is 5 seconds."
		exit 0
	else
		delay=$1
	fi
elif [ $# -eq 0 ]; then
	delay=5
else
	echo "Use -h for help"
	exit 0
fi

echo "Counting interrupts over $delay seconds ..."
awk -v wait_time=$delay \
'BEGIN { 
	# check for initial amount of interrupts
	interrups="/proc/interrupts";
	# grab the number of interrupts
	while ((getline < interrups) > 0) {
		arr[$1] = $2 
	}
	close(interrups)
	
	# wait 
	system("sleep " wait_time)
	
	printf "\n"
	printf "%-8s %-25s %-10s %-10s\n", "IRQ", "Interrupt Type", "Total Int", "Int/sec"
	print "------------------------------------------------------"
	# if a different number of interrupts occur, get interrupts/sec and display
	while ((getline < interrups) > 0) {
		diff = $2 - arr[$1]
		if(diff > 0) {
			printf "%-8s %-25s %-10s %-10s\n", $1, $3 " " $4 ":", diff, diff/wait_time 
		}
	}
	close(interrups)
	printf "\n"
}'
